<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Reporte de Resultados</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <style>
      .reporte-box {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        min-height: 950px;
        background: #fff;
        border-radius: 12px;
        max-width: 900px;
        margin: 0 auto;
        padding: 8px 24px 24px 24px;
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
        font-size: 13px;
      }
      .logo {
        height: 90px;
        margin-bottom: 0;
        margin-top: 0;
        display: block;
      }
      .d-flex.align-items-center.mb-1 {
        margin-bottom: 4px !important;
      }
      .datos-cliente-tabla {
        width: 100%;
        margin: 2px 0 8px 0;
        font-size: 13px;
        color: #333;
      }
      .datos-cliente-tabla td {
        padding: 2px 8px;
        vertical-align: top;
      }
      .titulo-reporte {
        font-size: 1.2rem;
        font-weight: bold;
        text-align: center;
        margin-bottom: 10px;
        margin-top: 0;
        color: #1a237e;
      }
      .table.no-borders,
      .table.no-borders th,
      .table.no-borders td {
        border: none !important;
      }
      .table th {
        background: #f4f6fa;
        color: #1a237e;
        font-weight: 600;
        font-size: 13px;
      }
      .table td {
        font-size: 13px;
      }
      .referencia-list {
        margin: 0;
        padding-left: 16px;
        font-size: 0.97em;
        color: #222;
      }
      .fuera-rango {
        color: #d32f2f;
        font-weight: bold;
      }
      .empresa-info {
        font-size: 12px;
        text-align: right;
        color: #444;
        line-height: 1.4;
      }
      .firma-footer {
        page-break-after: avoid;
        text-align: right;
      }
      @media print {
        thead {
          display: table-header-group;
        }
        .no-print {
          display: none !important;
        }
        body {
          background: #fff;
          padding: 0;
          font-size: 11px;
        }
        .reporte-box {
          box-shadow: none;
          border: none;
          margin: 0;
          padding: 0;
          font-size: 11px;
        }
        .firma-footer {
          page-break-after: avoid;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="reporte-box" id="reporte-pdf">
        <!-- Encabezado con logo y datos de la empresa -->
        <div class="d-flex justify-content-between align-items-center mb-1">
          <img
            id="logo-empresa"
            src="../images/empresa/logo_empresa.png"
            alt="Logo Empresa"
            class="logo"
            style="max-height: 90px"
          />
          <div class="empresa-info" id="empresa-info"></div>
        </div>

        <!-- Datos del paciente en dos columnas -->
        <table class="datos-cliente-tabla" id="tabla-datos-cliente">
          <!-- Se llenará dinámicamente -->
        </table>

        <!-- Título del reporte -->
        <div class="titulo-reporte">Reporte de Resultados</div>

        <!-- Tabla de resultados -->
        <table class="table no-borders" style="margin-top: 5px">
          <thead>
            <tr>
              <th>Prueba</th>
              <th>Metodología</th>
              <th>Resultado</th>
              <th>Unidades</th>
              <th>Valores de Referencia</th>
            </tr>
          </thead>
          <tbody id="tabla-resultados">
            <!-- Las filas se llenan vía JS -->
          </tbody>
        </table>

        <!-- Botón pequeño alineado a la derecha -->
        <div class="d-flex justify-content-end">
          <button
            id="btn-descargar-pdf"
            class="btn btn-primary btn-sm mt-2 mb-3 no-print"
          >
            <i class="bi bi-file-earmark-pdf"></i> Descargar PDF
          </button>
        </div>

        <!-- Pie de página solo al final -->
        <div class="firma-footer" id="firma-footer">
          <div class="d-flex justify-content-end align-items-end mt-4">
            <img
              id="firma-empresa"
              src=""
              alt="Firma y sello"
              style="height: 80px"
            />
          </div>
          <hr class="my-3" />
          <div style="font-size: 12px; color: #444; text-align: left">
            <div>(L) Laboratorio de Referencia</div>
            <div>* Resultados fuera de los rangos referenciales</div>
            <div>
              ** Muestra remitida por un laboratorio externo con convenio
            </div>
          </div>
        </div>
      </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script>
      // Asigna rutas por defecto al cargar la página
      const logo = document.getElementById("logo-empresa");
      logo.src = "../images/empresa/logo_empresa.png";
      const firma = document.getElementById("firma-empresa");
      firma.src = "../images/empresa/firma.png";

      function getParameterByName(name) {
        const url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        const regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)");
        const results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return "";
        return decodeURIComponent(results[2].replace(/\+/g, " "));
      }
      const cotizacion_id = getParameterByName("cotizacion_id");

      $(document).ready(function () {
        $.ajax({
          url: "datos-reporte.php",
          method: "GET",
          data: { cotizacion_id: cotizacion_id },
          dataType: "json",
          success: function (data) {
            // Logo y firma dinámicos si son diferentes a la ruta por defecto
            if (data.empresa.logo) {
              let logoRuta = "../../" + data.empresa.logo;
              $("#logo-empresa").attr(
                "src",
                logoRuta + "?ver=" + new Date().getTime()
              );
            }
            if (data.empresa.firma) {
              let firmaRuta = "../../" + data.empresa.firma;
              $("#firma-empresa").attr(
                "src",
                firmaRuta + "?ver=" + new Date().getTime()
              );
            }

            // Datos de empresa
            $("#empresa-info").html(
              `<strong>${data.empresa.nombre || ""}</strong><br>
               ${data.empresa.direccion || ""}<br>
               <span>Tel: ${data.empresa.telefono || ""}</span><br>
               <span>Celular: ${data.empresa.celular || ""}</span>`
            );
            // Datos de paciente en dos columnas
            $("#tabla-datos-cliente").html(`
              <tr>
                <td><strong>Paciente:</strong> ${
                  data.paciente.nombre || ""
                }</td>
                <td><strong>Código Cliente:</strong> ${
                  data.paciente.codigo_cliente || ""
                }</td>
              </tr>
              <tr>
                <td><strong>DNI:</strong> ${data.paciente.dni || ""}</td>
                <td><strong>Edad:</strong> ${
                  data.paciente.edad || ""
                }   <strong>Sexo:</strong> ${data.paciente.sexo || ""}</td>
              </tr>
              <tr>
                <td colspan="2"><strong>Fecha:</strong> ${
                  data.paciente.fecha || ""
                }</td>
              </tr>
            `);
            // Resultados
            let filas = "";
            data.items.forEach(function (item) {
              if (item.tipo === "Subtítulo" || item.tipo === "Título") {
                let colorFondo = item.color_fondo || "#f4f6fa";
                let colorTexto = item.color_texto || "#333";
                filas += `<tr>
                  <td colspan="5" style="background:${colorFondo};color:${colorTexto};font-weight:bold;border-radius:6px;">
                    ${item.prueba}
                  </td>
                </tr>`;
              } else if (item.tipo === "Parámetro") {
                let refHTML = "";
                let referencias = Array.isArray(item.referencias)
                  ? item.referencias
                  : item.referencia;
                if (Array.isArray(referencias)) {
                  refHTML = '<ul class="referencia-list">';
                  referencias.forEach(function (ref) {
                    if (typeof ref === "object" && ref.desc)
                      refHTML += `<li><strong>${ref.desc}:</strong> ${ref.valor}</li>`;
                    else refHTML += `<li>${ref.valor || ref}</li>`;
                  });
                  refHTML += "</ul>";
                } else if (referencias) {
                  refHTML = referencias;
                }
                // Formatea a 1 decimal si es numérico
                let valorFormateado = item.valor;
                if (
                  valorFormateado !== undefined &&
                  valorFormateado !== "" &&
                  !isNaN(Number(valorFormateado))
                ) {
                  valorFormateado = Number(valorFormateado).toFixed(1);
                }
                filas += `<tr>
                  <td>${item.prueba || ""}</td>
                  <td>${item.metodologia || ""}</td>
                  <td>${valorFormateado || ""}</td>
                  <td>${item.unidad || ""}</td>
                  <td>${refHTML || ""}</td>
                </tr>`;
              }
            });
            $("#tabla-resultados").html(filas);
          },
          error: function () {
            alert("No se pudo cargar el reporte. Intenta nuevamente.");
          },
        });

        // Botón para descargar el PDF
        $("#btn-descargar-pdf").click(function () {
          window.open(
            "descarga-pdf.php?cotizacion_id=" + cotizacion_id,
            "_blank"
          );
        });
      });
    </script>
  </body>
</html>
